<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒãƒ¼ã‚«ãƒ¼ï¼ˆç°¡æ˜“ç‰ˆï¼‰ - å¿ƒç†æˆ¦ã‚«ã‚¸ãƒãƒ¢ãƒ¼ãƒ‰</title>
    <style>
        /* ======================== */
        /* ã‚²ãƒ¼ãƒ ç”»é¢ã®CSS */
        /* ======================== */
        body {
            font-family: 'Arial', sans-serif;
            text-align: center;
            background-color: #0d230d;
            background-image: 
                url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 20" width="100%" height="20%"><path d="M10 20 H90 V10 Q50 0, 10 10 Z" fill="#8B0000"/><path d="M15 15 H85 V10 C80 5, 20 5, 15 10 Z" fill="#B22222"/></svg>') bottom center no-repeat;
            background-size: auto 100px, cover;
            background-attachment: fixed;
            color: #fff;
            padding: 10px;
            margin: 0;
            overflow-y: hidden;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background-color: rgba(0, 0, 0, 0.75);
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 8px 30px rgba(255, 215, 0, 0.3); 
            border: 5px solid #ccac00;
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ã¨æƒ…å ±ãƒãƒ¼ */
        h1 { 
            margin-top: 5px; 
            font-size: 1.8em; 
            display: inline-block;
            margin-right: 15px;
        }
        #infoBar {
            display: flex; justify-content: space-around; align-items: center; 
            padding: 8px 10px; background-color: #0b4920; border-radius: 8px;
            margin-bottom: 10px; font-size: 1em; font-weight: bold;
        }
        
        /* ã‚«ãƒ¼ãƒ‰ã‚¨ãƒªã‚¢ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        #gameArea {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #communityArea {
            width: 90%;
            margin: 10px 0;
            padding: 10px;
            border: 2px dashed #993399;
            border-radius: 8px;
        }
        #communityArea h3 { margin-top: 0; margin-bottom: 5px; font-size: 1em; }
        
        .hand h2 { font-size: 1.2em; margin: 0 0 5px 0; }
        .hand-status { font-size: 0.9em; }

        .cards {
            display: flex; justify-content: center; margin: 5px 0; min-height: 80px; flex-wrap: wrap;
        }

        .card { 
            background-color: #fff; color: #000; border: 1px solid #000; border-radius: 4px;
            width: 55px; height: 75px; 
            display: flex; flex-direction: column; justify-content: space-between;
            align-items: center; margin: 0 3px; padding: 4px; font-size: 1em;
            box-shadow: 1px 1px 3px rgba(0, 0, 0, 0.3); font-weight: bold;
        }
        .card.hidden { background-color: #8b0000; color: #fff; font-size: 0.8em; display: flex; justify-content: center; align-items: center; font-style: italic; }
        .card-suit { font-size: 1.2em !important; }
        
        /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚¨ãƒªã‚¢ã¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ */
        #preGameControls, #buttons {
            display: flex; justify-content: center; flex-wrap: wrap; gap: 10px;
            margin-bottom: 10px;
        }
        
        #preGameControls input[type="number"] {
            width: 60px; height: 35px; font-size: 1.2em; padding: 5px;
        }

        #actionButtons button, #dealButton, #nextGameButton, #ruleButton, #tutorialButton {
             padding: 8px 15px; font-size: 0.9em; margin: 0 2px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;
        }
        
        #ruleButton { background-color: #00bcd4; color: #fff; }
        #tutorialButton { background-color: #ffc107; color: #333; } /* ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ãƒœã‚¿ãƒ³ */
        #dealButton { background-color: #2196f3; color: #fff; }
        #foldButton { background-color: #8b0000; color: #fff; }
        #checkCallButton { background-color: #ff9800; color: #fff; }
        #raiseButton { background-color: #4caf50; color: #fff; }


        /* ======================== */
        /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— (è¦–èªæ€§æ”¹å–„ã®ãŸã‚ä¸‹éƒ¨ã«å›ºå®š) */
        /* ======================== */
        #messagePopup {
            position: fixed;
            bottom: 20px; /* ç”»é¢ä¸‹éƒ¨ã«å›ºå®š */
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(255, 255, 255, 0.95);
            color: #333;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            font-size: 1.2em;
            font-weight: bold;
            z-index: 50;
            cursor: pointer;
            display: none;
            max-width: 90%; /* æ¨ªå¹…ã‚’åºƒã’ã‚‹ */
            text-align: left;
        }
        .dealer-aa { 
            font-size: 1.5em; 
            display: inline-block; 
            margin-right: 10px;
        }
        .highlight {
            color: #8B0000;
            font-weight: bold;
            border-bottom: 2px solid #ffc107;
            padding-bottom: 2px;
        }

        /* ======================== */
        /* ãƒ«ãƒ¼ãƒ«ãƒ¢ãƒ¼ãƒ€ãƒ«CSS (å¤‰æ›´ãªã—) */
        /* ======================== */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            display: flex; justify-content: center; align-items: center; z-index: 100;
        }

        .modal-content {
            background-color: #f5f5dc; 
            color: #333;
            width: 90%; 
            max-width: 600px;
            max-height: 90vh; 
            overflow-y: auto; 
            padding: 30px 20px 15px 20px;
            border-radius: 10px;
            position: relative;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.9);
            border: 8px solid #ccac00; 
            background-image: linear-gradient(rgba(0,0,0,0.05) 1px, transparent 1px);
            background-size: 20px 20px; 
            text-shadow: 1px 1px 0 rgba(255,255,255,0.3); 
        }
        .close-button { 
            position: absolute; 
            top: 5px; 
            right: 15px; 
            background: none; 
            border: none; 
            color: #333; 
            font-size: 2em; 
            cursor: pointer; 
            z-index: 101; 
            padding: 5px;
            line-height: 1;
        }
        .rule-title { color: #8b0000; border-bottom: 2px solid #ccac00; padding-bottom: 5px; margin-bottom: 15px; }
        .rule-list { text-align: left; list-style-type: disc; margin-left: 20px; font-size: 0.95em; }
        .rule-list li { margin-bottom: 8px; }
        .hand-rank-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9em;}
        .hand-rank-table th, .hand-rank-table td { border: 1px solid #ccc; padding: 5px; text-align: center; }
        .hand-rank-table th { background-color: #ccac00; color: #333; }

    </style>
</head>
<body>

<div id="ruleModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <button id="closeModal" class="close-button">&times;</button>
        <h2 class="rule-title">â™¦ ãƒãƒ¼ã‚«ãƒ¼ï¼ˆç°¡æ˜“ç‰ˆï¼‰ã®ãƒ«ãƒ¼ãƒ« â™¦</h2>
        
        <p style="text-align: left;">
            ãƒãƒ¼ã‚«ãƒ¼ã¯ã€æ‰‹æœ­2æšã¨å ´æœ­5æšï¼ˆé †æ¬¡å…¬é–‹ï¼‰ã®ä¸­ã‹ã‚‰**æœ€ã‚‚å¼·ã„5æš**ã®çµ„ã¿åˆã‚ã›ï¼ˆå½¹ï¼‰ã‚’ä½œã‚Šã€ãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼ã¨å‹è² ã—ã¾ã™ã€‚
            å‹è² ã®é€”ä¸­ã§ã€ç›¸æ‰‹ã‚ˆã‚Šå¼·ã„å½¹ãŒã§ããã†ã‹äºˆæ¸¬ã—ã€**ãƒãƒƒãƒ—ã‚’è³­ã‘åˆã†**ã®ãŒé†é†å‘³ã§ã™ã€‚
        </p>

        <h3 style="color: #8b0000; margin-top: 10px; text-align: left;">1. ã‚²ãƒ¼ãƒ ã®æµã‚Œã¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h3>
        <ul class="rule-list">
            <li>**ã‚¢ãƒ³ãƒ†ã‚£**: ã‚²ãƒ¼ãƒ é–‹å§‹å‰ã«å‚åŠ æ–™ã‚’è³­ã‘ã¾ã™ã€‚</li>
            <li>**ã‚«ãƒ¼ãƒ‰å…¬é–‹/ãƒ™ãƒƒãƒˆ**: ãƒ•ãƒ­ãƒƒãƒ—(3æš)â†’ã‚¿ãƒ¼ãƒ³(1æš)â†’ãƒªãƒãƒ¼(1æš)ã¨ã‚«ãƒ¼ãƒ‰ãŒé–‹ããŸã³ã«ã€ãƒãƒƒãƒ—ã‚’è³­ã‘ã‚‹ãƒãƒ£ãƒ³ã‚¹ãŒã‚ã‚Šã¾ã™ã€‚</li>
            <li>**[ã‚¢ã‚¯ã‚·ãƒ§ãƒ³]**
                <ul>
                    <li>**ãƒã‚§ãƒƒã‚¯**: ãƒãƒƒãƒ—ã‚’è³­ã‘ãšã«é †ç•ªã‚’å›ã™ã€‚ï¼ˆèª°ã‚‚è³­ã‘ã¦ã„ãªã„å ´åˆï¼‰</li>
                    <li>**ã‚³ãƒ¼ãƒ«**: ç›¸æ‰‹ãŒè³­ã‘ãŸé¡ã¨åŒé¡ã‚’å‡ºã™ã€‚ï¼ˆå‹è² ã«ä¹—ã‚‹ï¼‰</li>
                    <li>**ãƒ¬ã‚¤ã‚º**: ç›¸æ‰‹ãŒè³­ã‘ãŸé¡ã‚ˆã‚Šå¤šãå‡ºã™ã€‚ï¼ˆè³­ã‘é‡‘ã‚’é‡£ã‚Šä¸Šã’ã‚‹ï¼‰</li>
                    <li>**ãƒ•ã‚©ãƒ¼ãƒ«ãƒ‰**: æ‰‹æœ­ã‚’æ¨ã¦ã¦å‹è² ã‹ã‚‰é™ã‚Šã‚‹ã€‚ï¼ˆ**è³­ã‘ãŸãƒãƒƒãƒ—ã¯æ²¡å**ã•ã‚Œã€ç›¸æ‰‹ãŒãƒãƒƒãƒˆã‚’ç·å–ã‚Šã™ã‚‹ï¼‰</li>
                </ul>
            </li>
            <li>**ã‚·ãƒ§ãƒ¼ãƒ€ã‚¦ãƒ³**: æœ€çµ‚çš„ã«å½¹ãŒå¼·ã„æ–¹ãŒãƒãƒƒãƒˆï¼ˆç·è³­ã‘é‡‘ï¼‰ã‚’ç·å–ã‚Šã—ã¾ã™ã€‚</li>
        </ul>

        <h3 style="color: #8b0000; margin-top: 10px; text-align: left;">2. å½¹ã®å¼·ã•ï¼ˆä¸Šä½ã®ã¿ï¼‰</h3>
        <table class="hand-rank-table">
            <thead>
                <tr><th>ãƒ©ãƒ³ã‚¯</th><th>å½¹ã®åç§°</th><th>èª¬æ˜</th></tr>
            </thead>
            <tbody>
                <tr><td>æœ€å¼·</td><td>ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆãƒ•ãƒ©ãƒƒã‚·ãƒ¥</td><td>é€£ç•ªã§åŒã˜ãƒãƒ¼ã‚¯ã®5æš</td></tr>
                <tr><td>é«˜</td><td>ãƒ•ã‚©ãƒ¼ã‚«ãƒ¼ãƒ‰</td><td>åŒã˜æ•°å­—ãŒ4æš</td></tr>
                <tr><td>ä¸­</td><td>ãƒ•ãƒ«ãƒã‚¦ã‚¹</td><td>3æšã®åŒã˜æ•°å­—ï¼‹2æšã®åŒã˜æ•°å­—</td></tr>
                <tr><td>ä¸¦</td><td>ãƒ•ãƒ©ãƒƒã‚·ãƒ¥</td><td>åŒã˜ãƒãƒ¼ã‚¯ã®5æš</td></tr>
                <tr><td>ä½</td><td>ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆ</td><td>é€£ç•ªã®5æš</td></tr>
            </tbody>
        </table>
        
        <p style="color:#8b0000; font-weight: bold; margin-top: 15px;">æº–å‚™ãŒã§ããŸã‚‰ã€å³ä¸Šã® [âœ•] ãƒœã‚¿ãƒ³ã§é–‰ã˜ã¦ã‚²ãƒ¼ãƒ ã‚’å§‹ã‚ã¾ã—ã‚‡ã†ã€‚</p>
    </div>
</div>

<div id="messagePopup" onclick="hideMessagePopup()">
    </div>

<div class="container">
    <h1>POKER (ç°¡æ˜“ç‰ˆ)</h1>
    <button id="ruleButton">ãƒ«ãƒ¼ãƒ«ç¢ºèª</button>
    <button id="tutorialButton">ğŸ’¡ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«</button>
    
    <div id="infoBar">
        <div class="info-item">
            <span class="chip-icon">ğŸ’°</span> ãƒãƒƒãƒ—: <span id="chipsAmount">1000</span>
        </div>
        <div class="info-item">
            <span class="pot-icon">ğŸ”¥</span> ãƒãƒƒãƒˆç·é¡: <span id="potAmount">0</span>
        </div>
    </div>

    <div id="gameArea">
        <div id="dealerHand" class="hand">
            <h2>ãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼: <span id="dealerHandStatus" class="hand-status">?</span></h2>
            <div id="dealerCards" class="cards"></div>
        </div>
        
        <div id="communityArea">
            <h3>å ´æœ­</h3>
            <div id="communityCards" class="cards"></div>
        </div>

        <div id="playerHand" class="hand">
            <h2>ã‚ãªãŸ: <span id="playerHandStatus" class="hand-status">?</span></h2>
            <div id="playerCards" class="cards"></div>
        </div>
    </div>

    <div id="currentBetStatus">
        ãƒ™ãƒƒãƒˆé¡ï¼šãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼ <span id="dealerCurrentBet">0</span> / ã‚ãªãŸ <span id="playerCurrentBet">0</span>
    </div>

    <div id="preGameControls">
        <div>
            <label for="anteAmount">ã‚¢ãƒ³ãƒ†ã‚£:</label>
            <input type="number" id="anteAmount" value="10" min="10" step="10">
        </div>
        <div>
            <label for="raiseAmount">ãƒ¬ã‚¤ã‚ºé¡:</label>
            <input type="number" id="raiseAmount" value="20" min="10" step="10">
        </div>
    </div>

    <div id="buttons">
        <button id="dealButton">ã‚²ãƒ¼ãƒ é–‹å§‹ (ã‚¢ãƒ³ãƒ†ã‚£ã‚’è³­ã‘ã‚‹)</button>
        <div id="actionButtons" style="display: none;">
            <button id="foldButton" disabled>ãƒ•ã‚©ãƒ¼ãƒ«ãƒ‰</button>
            <button id="checkCallButton" disabled>ãƒã‚§ãƒƒã‚¯ / ã‚³ãƒ¼ãƒ«</button>
            <button id="raiseButton" disabled>ãƒ¬ã‚¤ã‚º</button>
        </div>
    </div>
    
    <div id="postGameButtons" style="display: none; margin-top: 10px;">
        <button id="nextGameButton">æ¬¡ã®å‹è² ã¸</button>
    </div>
</div>

<script>
    // ----------------------------------------------------
    //  ã‚²ãƒ¼ãƒ ã®çŠ¶æ…‹ã¨å®šæ•°
    // ----------------------------------------------------
    const SUITS = ['â™ ', 'â™¥', 'â™¦', 'â™£'];
    const VALUES = ['2', '3', '4', '5', '6', '7', '8', '9', 'T', 'J', 'Q', 'K', 'A']; // T=10
    const VALUE_MAP = {'2': 2, '3': 3, '4': 4, '5': 5, '6': 6, '7': 7, '8': 8, '9': 9, 'T': 10, 'J': 11, 'Q': 12, 'K': 13, 'A': 14};
    const HAND_RANKINGS = [
        'ãƒã‚¤ã‚«ãƒ¼ãƒ‰', 'ãƒ¯ãƒ³ãƒšã‚¢', 'ãƒ„ãƒ¼ãƒšã‚¢', 'ã‚¹ãƒªãƒ¼ã‚«ãƒ¼ãƒ‰', 'ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆ', 
        'ãƒ•ãƒ©ãƒƒã‚·ãƒ¥', 'ãƒ•ãƒ«ãƒã‚¦ã‚¹', 'ãƒ•ã‚©ãƒ¼ã‚«ãƒ¼ãƒ‰', 'ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆãƒ•ãƒ©ãƒƒã‚·ãƒ¥', 'ãƒ­ã‚¤ãƒ¤ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆãƒ•ãƒ©ãƒƒã‚·ãƒ¥'
    ];

    // HTMLè¦ç´ 
    const chipsAmountEl = document.getElementById('chipsAmount');
    const potAmountEl = document.getElementById('potAmount');
    const dealerCardsEl = document.getElementById('dealerCards');
    const playerCardsEl = document.getElementById('playerCards');
    const communityCardsEl = document.getElementById('communityCards');
    const messagePopupEl = document.getElementById('messagePopup');
    const dealButton = document.getElementById('dealButton');
    const actionButtons = document.getElementById('actionButtons');
    const foldButton = document.getElementById('foldButton');
    const checkCallButton = document.getElementById('checkCallButton');
    const raiseButton = document.getElementById('raiseButton');
    const anteAmountInput = document.getElementById('anteAmount');
    const raiseAmountInput = document.getElementById('raiseAmount');
    const dealerCurrentBetEl = document.getElementById('dealerCurrentBet');
    const playerCurrentBetEl = document.getElementById('playerCurrentBet');
    const dealerHandStatusEl = document.getElementById('dealerHandStatus');
    const playerHandStatusEl = document.getElementById('playerHandStatus');
    const postGameButtons = document.getElementById('postGameButtons');
    const ruleModal = document.getElementById('ruleModal');
    const closeModalButton = document.getElementById('closeModal');
    const ruleButton = document.getElementById('ruleButton');
    const tutorialButton = document.getElementById('tutorialButton');
    const nextGameButton = document.getElementById('nextGameButton');
    
    // ã‚²ãƒ¼ãƒ å¤‰æ•°
    let chips = 1000;
    let pot = 0;
    let deck = [];
    let dealerHand = []; // 2æš
    let playerHand = []; // 2æš
    let communityCards = []; // æœ€å¤§5æš
    let dealerBet = 0;
    let playerBet = 0;
    let currentBettingRound = 0; // 0: Pre-flop, 1: Flop, 2: Turn, 3: River
    let isGameOver = true;
    let lastRaiser = null; // æœ€å¾Œã«ãƒ¬ã‚¤ã‚º/ãƒ™ãƒƒãƒˆã—ãŸäºº ('player' or 'dealer')
    let isTutorial = false; // ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ãƒ¢ãƒ¼ãƒ‰ã‹ã©ã†ã‹
    let tutorialStep = 0; // ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã®ã‚¹ãƒ†ãƒƒãƒ—

    // ----------------------------------------------------
    //  ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
    // ----------------------------------------------------

    function displayDealerMessage(type, amount = 0, handName = '', customMessage = '') {
        const messageHtml = getDealerMessage(type, amount, handName, customMessage);
        messagePopupEl.innerHTML = messageHtml;
        messagePopupEl.style.display = 'block';
    }

    window.hideMessagePopup = function() {
        messagePopupEl.style.display = 'none';
        
        // ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã€ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‰ã˜ãŸã‚‰æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¸
        if (isTutorial) {
            handleTutorialStep();
        }
    }

    function getDealerMessage(type, amount = 0, handName = '', customMessage = '') {
        let aa = '';
        let message = customMessage || '';
        const currentPot = pot + dealerBet + playerBet;
        const potMsg = `ãƒãƒƒãƒˆ: ${currentPot}`;

        if (customMessage) {
             aa = isTutorial ? '(ğŸ¤–)' : '(^_^;)';
        } else {
            switch (type) {
                case 'start': aa = '(*^.^*)'; message = `ã‚¢ãƒ³ãƒ†ã‚£ã‚’æ±ºã‚ã¦ã€ã‚²ãƒ¼ãƒ é–‹å§‹ã‚ˆï¼`; break;
                case 'ante': aa = '(^_^)'; message = `ã‚¢ãƒ³ãƒ†ã‚£ ${amount}ã€‚ã•ã‚ã€å‹è² ã‚ˆï¼`; break;
                case 'flop': aa = '(Â°Ï‰Â°)'; message = `ãƒ•ãƒ­ãƒƒãƒ—ï¼3æšã®ã‚«ãƒ¼ãƒ‰ãŒå…¬é–‹ã•ã‚ŒãŸã‚ã€‚${potMsg}`; break;
                case 'turn': aa = '(-Ï‰-)'; message = `ã‚¿ãƒ¼ãƒ³ï¼4æšç›®ã®ã‚«ãƒ¼ãƒ‰ã‚ˆã€‚${potMsg}`; break;
                case 'river': aa = '(ãƒ¡_ãƒ¡)'; message = `ãƒªãƒãƒ¼ï¼æœ€çµ‚ã‚«ãƒ¼ãƒ‰ã‚ˆã€‚${potMsg}`; break;
                case 'dealer_bet': aa = '(^-^)/'; message = `ãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼ãŒ ${amount} ãƒ™ãƒƒãƒˆã€‚ã‚ãªãŸã®ç•ªã‚ˆã€‚`; break;
                case 'dealer_call': aa = '(-_-)'; message = `ãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼ã¯ã‚³ãƒ¼ãƒ«ã€‚æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã«ç§»ã‚‹ã‚ã€‚`; break;
                case 'dealer_raise': aa = 'o(^-^)o'; message = `ãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼ãŒ ${amount} ã«ãƒ¬ã‚¤ã‚ºã€‚ã©ã†ã™ã‚‹ï¼Ÿ`; break;
                case 'dealer_check': aa = '(^_^)'; message = `ãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼ã¯ãƒã‚§ãƒƒã‚¯ã‚ˆã€‚ã‚ãªãŸã®ç•ªã‚ˆã€‚`; break;
                case 'player_win_showdown': aa = '(^O^)/'; message = `ğŸ‰ **${handName}** ã§å‹åˆ©ï¼ãƒãƒƒãƒˆ ${currentPot} ã‚’ç²å¾—ï¼`; break;
                case 'dealer_win_showdown': aa = '(-_ãƒ¡)'; message = `ğŸ’” ${handName} ã«è² ã‘ãŸã‚ã€‚ãƒãƒƒãƒ—ã‚’å¤±ã£ãŸã‚ã­ã€‚`; break;
                case 'push': aa = '(-_-)'; message = `ãƒ—ãƒƒã‚·ãƒ¥ï¼ˆå¼•ãåˆ†ã‘ï¼‰ã€‚ãƒãƒƒãƒˆ ${currentPot} ã‚’åˆ†ã‘åˆã†ã‚ã€‚`; break;
                case 'player_fold': aa = 'ãƒ»_ãƒ»'; message = `ãƒ•ã‚©ãƒ¼ãƒ«ãƒ‰ã­ã€‚ãƒãƒƒãƒˆ ${currentPot} ã¯ãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼ã®ã‚‚ã®ã‚ˆã€‚`; break;
                case 'dealer_fold': aa = 'ï¼¼(>_<)ï¼'; message = `ãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼ãŒé™ã‚ŠãŸã‚ï¼ãƒãƒƒãƒˆ ${currentPot} ã‚’ç²å¾—ï¼`; break;
                default: aa = '^_^;'; message = 'æ¬¡ã®å‹è² ã¸ã©ã†ãã€‚';
            }
        }
        
        return `<div class="dealer-aa">${aa}</div>${message}<br><small>(ã‚¯ãƒªãƒƒã‚¯ã§æ¬¡ã¸)</small>`;
    }

    function updateDisplay() {
        chipsAmountEl.textContent = chips;
        potAmountEl.textContent = pot + dealerBet + playerBet;
        dealerCurrentBetEl.textContent = dealerBet;
        playerCurrentBetEl.textContent = playerBet;
        
        // ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ä¸­ã¯ã‚¢ãƒ³ãƒ†ã‚£ãƒ»ãƒ¬ã‚¤ã‚ºé¡ã®å¤‰æ›´ã‚’ç¦æ­¢
        anteAmountInput.disabled = isTutorial;
        raiseAmountInput.disabled = isTutorial;

        anteAmountInput.max = chips;
        raiseAmountInput.max = chips;
        
        if (parseInt(anteAmountInput.value) > chips) anteAmountInput.value = chips;
        if (parseInt(raiseAmountInput.value) > chips) raiseAmountInput.value = chips;
    }

    function createAndShuffleDeck() {
        deck = [];
        for (let suit of SUITS) {
            for (let value of VALUES) {
                deck.push({ suit, value });
            }
        }
        for (let i = deck.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [deck[i], deck[j]] = [deck[j], deck[i]];
        }
    }

    function drawCard() {
        return deck.pop();
    }

    // ã‚«ãƒ¼ãƒ‰ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ç”Ÿæˆã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
    function makeCard(suit, value) {
        return { suit, value };
    }

    function getCardHtml(card, isHidden = false) {
        if (isHidden) {
            return `<div class="card hidden">POKER<br>CARD</div>`;
        }
        const color = (card.suit === 'â™¥' || card.suit === 'â™¦') ? 'red' : 'black';
        return `
            <div class="card" style="color: ${color};">
                <div class="card-value">${card.value}</div>
                <div class="card-suit">${card.suit}</div>
                <div class="card-value">${card.value}</div>
            </div>
        `;
    }

    function renderHands(showDealer = false) {
        dealerCardsEl.innerHTML = dealerHand.map(card => 
            getCardHtml(card, !showDealer)
        ).join('');
        
        playerCardsEl.innerHTML = playerHand.map(card => 
            getCardHtml(card)
        ).join('');
        
        // å ´æœ­ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        communityCardsEl.innerHTML = communityCards.map(card => 
            getCardHtml(card)
        ).join('');

        if (showDealer && communityCards.length === 5) {
             const playerResult = evaluateHand([...playerHand, ...communityCards]);
             const dealerResult = evaluateHand([...dealerHand, ...communityCards]);
             playerHandStatusEl.textContent = playerResult.name;
             dealerHandStatusEl.textContent = dealerResult.name;
        } else {
             if (communityCards.length >= 3) {
                const currentHand = evaluateHand([...playerHand, ...communityCards]);
                playerHandStatusEl.textContent = `(${currentHand.name}ã®å¯èƒ½æ€§)`;
             } else {
                 playerHandStatusEl.textContent = 'ï¼Ÿ';
             }
             dealerHandStatusEl.textContent = '?';
        }
    }

    // ----------------------------------------------------
    //  ãƒãƒ¼ã‚«ãƒ¼å½¹ã®åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ (ç°¡æ˜“ç‰ˆ) - å‰²æ„›
    // ----------------------------------------------------
    function evaluateHand(cards) {
        // ... (å½¹ã®åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ã¯å‰å›ã®ã‚‚ã®ã‚’ãã®ã¾ã¾ä½¿ç”¨)
        if (cards.length < 5) return { rank: 0, name: 'ãƒã‚¤ã‚«ãƒ¼ãƒ‰', highCardValue: 0 };
        
        const valuesCount = cards.reduce((acc, card) => {
            const value = card.value;
            acc[value] = (acc[value] || 0) + 1;
            return acc;
        }, {});
        
        const suitsCount = cards.reduce((acc, card) => {
            acc[card.suit] = (acc[card.suit] || 0) + 1;
            return acc;
        }, {});

        let rank = 0; 
        let pairs = 0;
        let triples = 0;
        let quads = 0;

        for (const count of Object.values(valuesCount)) {
            if (count === 2) pairs++;
            if (count === 3) triples++;
            if (count === 4) quads++;
        }

        if (quads > 0) rank = 7; 
        else if (triples > 0 && pairs >= 1) rank = 6; 
        else if (triples > 0) rank = 3; 
        else if (pairs >= 2) rank = 2; 
        else if (pairs === 1) rank = 1; 

        let uniqueValues = [...new Set(cards.map(card => VALUE_MAP[card.value]))].sort((a, b) => a - b);
        if (uniqueValues.includes(14)) uniqueValues.unshift(1);
        
        let isStraight = false;
        let highStraightValue = 0;
        if (uniqueValues.length >= 5) {
            for (let i = 0; i <= uniqueValues.length - 5; i++) {
                if (uniqueValues[i+4] === uniqueValues[i] + 4) {
                    isStraight = true;
                    highStraightValue = uniqueValues[i+4];
                }
            }
        }
        if (isStraight) rank = Math.max(rank, 4);

        let isFlush = Object.values(suitsCount).some(count => count >= 5);
        if (isFlush) rank = Math.max(rank, 5);

        if (isStraight && isFlush) {
             rank = 8;
             if (highStraightValue === 14) rank = 9; 
        }
        
        let highCardValue = uniqueValues[uniqueValues.length - 1] || 0;
        return { rank: rank, name: HAND_RANKINGS[rank], highCardValue: highCardValue };
    }


    // ----------------------------------------------------
    //  ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«æ©Ÿèƒ½
    // ----------------------------------------------------
    
    function startTutorial() {
        // å…¨ã‚²ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
        resetGame(false); 
        isTutorial = true;
        tutorialStep = 0;
        
        chips = 200; // ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ç”¨ã®ãƒãƒƒãƒ—
        
        // UIã®åˆæœŸåŒ–
        dealButton.style.display = 'none';
        tutorialButton.style.display = 'none';
        anteAmountInput.value = 10;
        
        // å›ºå®šã®ã‚«ãƒ¼ãƒ‰ã‚’è¨­å®š 
        playerHand = [makeCard('â™¥', 'Q'), makeCard('â™¥', 'K')]; // QKsuited
        dealerHand = [makeCard('â™ ', '7'), makeCard('â™£', '7')]; // 77Pair
        
        communityCards = [];
        
        updateDisplay();
        renderHands(false);
        
        // æœ€åˆã®ã‚¹ãƒ†ãƒƒãƒ—ã¸
        displayDealerMessage('default', 0, '', 'ã‚ˆã†ã“ããƒãƒ¼ã‚«ãƒ¼ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã¸ï¼<br>ã“ã“ã§ã¯ã€ãƒãƒ¼ã‚«ãƒ¼ã®åŸºæœ¬çš„ãªæµã‚Œã¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å­¦ã³ã¾ã™ã€‚');
    }

    function handleTutorialStep() {
        tutorialStep++;
        
        // ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã®é€²è¡Œãƒ­ã‚¸ãƒƒã‚¯
        switch(tutorialStep) {
            case 1:
                displayDealerMessage('default', 0, '', 'ã¾ãšã€ã‚²ãƒ¼ãƒ é–‹å§‹ã®å‚åŠ æ–™ã¨ã—ã¦ãŠäº’ã„ã«ãƒãƒƒãƒ—ã‚’è³­ã‘ã¾ã™ã€‚ã“ã‚Œã‚’ <span class="highlight">ã‚¢ãƒ³ãƒ†ã‚£</span> ã¨å‘¼ã³ã¾ã™ã€‚ä»Šå›ã¯10ãƒãƒƒãƒ—ãšã¤è³­ã‘ã¾ã—ãŸã€‚');
                chips -= 10;
                pot += 20; 
                playerBet = 10;
                dealerBet = 10;
                updateDisplay();
                break;
            case 2:
                displayDealerMessage('default', 0, '', 'ã‚ãªãŸã¨ãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼ã« <span class="highlight">æ‰‹æœ­ï¼ˆãƒ›ãƒ¼ãƒ«ã‚«ãƒ¼ãƒ‰ï¼‰</span> ãŒ2æšé…ã‚‰ã‚Œã¾ã—ãŸã€‚ã‚ãªãŸã®æ‰‹æœ­ã¯Qã¨Kã€‚ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆã‚„ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ãŒæœŸå¾…ã§ãã¾ã™ã€‚');
                break;
            case 3:
                displayDealerMessage('default', 0, '', 'ãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼ãŒ20ãƒãƒƒãƒ—ã« <span class="highlight">ãƒ¬ã‚¤ã‚º</span> ã—ã¦ãã¾ã—ãŸã€‚ã‚ãªãŸã¯ä»Šã€ã‚ã¨10ãƒãƒƒãƒ—ã‚’æ‰•ã†å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚');
                // ãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼ãŒãƒ¬ã‚¤ã‚ºã—ãŸçŠ¶æ…‹ã‚’å¼·åˆ¶
                pot += 10;
                dealerBet += 10;
                updateDisplay();
                playerActionPhase();
                // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä¿ƒã™ï¼ˆãƒœã‚¿ãƒ³ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã™ã‚‹ï¼‰
                displayDealerMessage('default', 0, '', 'ç›¸æ‰‹ã®ãƒ™ãƒƒãƒˆé¡ã«åˆã‚ã›ã‚‹ <span class="highlight">ã‚³ãƒ¼ãƒ« (10)</span> ã‚’é¸ã³ã€å‹è² ã«ä¹—ã£ã¦ã¿ã¾ã—ã‚‡ã†ã€‚');
                break; // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚¯ãƒªãƒƒã‚¯ã‚’å¾…ã¤ãŸã‚ã€break
            case 4:
                // nextPhaseã§å‘¼ã°ã‚Œã‚‹
                displayDealerMessage('default', 0, '', 'ã‚³ãƒ¼ãƒ«ãŒå®Œäº†ã—ã¾ã—ãŸã€‚æ¬¡ã« <span class="highlight">ãƒ•ãƒ­ãƒƒãƒ—</span> ã¨ã—ã¦å ´æœ­ãŒ3æšé–‹ã‹ã‚Œã¾ã™ã€‚');
                break;
            case 5: // ãƒ•ãƒ­ãƒƒãƒ—å¾Œã®èª¬æ˜
                // å›ºå®šã®ãƒ•ãƒ­ãƒƒãƒ—ã‚«ãƒ¼ãƒ‰ã‚’è¨­å®š (Kâ™£ Jâ™  Aâ™¦) -> ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆãƒ‰ãƒ­ãƒ¼ (Q, T)
                communityCards = [makeCard('â™£', 'T'), makeCard('â™ ', 'J'), makeCard('â™¦', 'A')]; // T J A -> Qã§ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆ
                renderHands(false);
                displayDealerMessage('default', 0, '', 'ãƒ•ãƒ­ãƒƒãƒ—ãŒé–‹ãã¾ã—ãŸï¼ã‚ãªãŸã®æ‰‹æœ­ (Q) ã¨å ´æœ­ã§ <span class="highlight">ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆ</span>ãŒå®Œæˆã™ã‚‹å¯èƒ½æ€§ãŒéå¸¸ã«é«˜ããªã‚Šã¾ã—ãŸï¼');
                
                // ãƒ™ãƒƒãƒˆé¡ãƒªã‚»ãƒƒãƒˆ
                pot += dealerBet + playerBet; 
                dealerBet = 0; playerBet = 0;
                updateDisplay();
                
                playerActionPhase();
                displayDealerMessage('default', 0, '', 'èª°ã‚‚ãƒ™ãƒƒãƒˆã—ã¦ã„ãªã„ã®ã§ã€ä»Šå›ã¯ <span class="highlight">ãƒã‚§ãƒƒã‚¯</span> ã‚’é¸ã³ã€ã‚¿ãƒ€ã§æ¬¡ã®ã‚«ãƒ¼ãƒ‰ã‚’è¦‹ã¾ã—ã‚‡ã†ã€‚');
                break; // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚¯ãƒªãƒƒã‚¯ã‚’å¾…ã¤ãŸã‚ã€break
            case 6:
                // ãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼ã®ãƒã‚§ãƒƒã‚¯å¾Œã®å‡¦ç†
                displayDealerMessage('default', 0, '', 'ãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼ã‚‚ãƒã‚§ãƒƒã‚¯ã—ã¾ã—ãŸã€‚4æšç›®ã®ã‚«ãƒ¼ãƒ‰ã€<span class="highlight">ã‚¿ãƒ¼ãƒ³</span> ãŒé–‹ã‹ã‚Œã¾ã™ã€‚');
                break;
            case 7: // ã‚¿ãƒ¼ãƒ³å¾Œã®èª¬æ˜
                // ã‚¿ãƒ¼ãƒ³ã‚«ãƒ¼ãƒ‰ (Tâ™¥) -> ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆå®Œæˆï¼
                communityCards.push(makeCard('â™¥', 'Q'));
                renderHands(false);
                displayDealerMessage('default', 0, '', 'ã‚¿ãƒ¼ãƒ³ãŒé–‹ãã¾ã—ãŸï¼ã‚ãªãŸã®æ‰‹æœ­ã¨å ´æœ­ã§ <span class="highlight">ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆ</span> ãŒå®Œæˆã—ã¾ã—ãŸï¼');
                
                // ãƒ™ãƒƒãƒˆé¡ãƒªã‚»ãƒƒãƒˆ
                pot += dealerBet + playerBet; 
                dealerBet = 0; playerBet = 0;
                updateDisplay();
                
                // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ãƒ™ãƒƒãƒˆã‚’å¼·åˆ¶
                playerActionPhase();
                raiseAmountInput.value = 30; // ãƒ¬ã‚¤ã‚ºé¡ã‚’å›ºå®š
                displayDealerMessage('default', 0, '', 'ãƒãƒ£ãƒ³ã‚¹ã§ã™ï¼<span class="highlight">ãƒ¬ã‚¤ã‚º (30)</span> ã‚’é¸ã³ã€ãƒãƒƒãƒ—ã‚’å¢—ã‚„ã—ã¾ã—ã‚‡ã†ï¼');
                break; // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚¯ãƒªãƒƒã‚¯ã‚’å¾…ã¤ãŸã‚ã€break
            case 8:
                // ãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼ãŒã‚³ãƒ¼ãƒ«ã—ãŸå¾Œã®ã‚·ãƒ§ãƒ¼ãƒ€ã‚¦ãƒ³ã¸
                displayDealerMessage('default', 0, '', 'ãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼ãŒã‚ãªãŸã®ãƒ¬ã‚¤ã‚ºã«ã‚³ãƒ¼ãƒ«ã—ã¾ã—ãŸã€‚æœ€å¾Œã®ã‚«ãƒ¼ãƒ‰ã€<span class="highlight">ãƒªãƒãƒ¼</span> ãŒé–‹ã‹ã‚Œã¾ã™ã€‚');
                break;
            case 9:
                // ãƒªãƒãƒ¼ã‚«ãƒ¼ãƒ‰ (ãƒ©ãƒ³ãƒ€ãƒ )
                communityCards.push(makeCard('â™¦', '2'));
                renderHands(false);
                nextPhase(); // ã‚·ãƒ§ãƒ¼ãƒ€ã‚¦ãƒ³ã¸
                tutorialStep = 10;
                break;
            case 10:
                // ã‚·ãƒ§ãƒ¼ãƒ€ã‚¦ãƒ³å¾Œã®å‡¦ç†ã¯é€šå¸¸ãƒ•ãƒ­ãƒ¼ã«ä»»ã›ã‚‹
                displayDealerMessage('default', 0, '', 'å…¨ã¦ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒçµ‚äº†ã—ã€<span class="highlight">ã‚·ãƒ§ãƒ¼ãƒ€ã‚¦ãƒ³</span> ã§ã™ã€‚<br>ãŠã‚ã§ã¨ã†ï¼ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆã§å‹åˆ©ã—ã¾ã—ãŸã€‚');
                postGameButtons.style.display = 'block';
                nextGameButton.textContent = 'é€šå¸¸ã‚²ãƒ¼ãƒ ã¸'; // ãƒœã‚¿ãƒ³ãƒ†ã‚­ã‚¹ãƒˆä¿®æ­£
                nextGameButton.onclick = () => {
                    alert('ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã‚’çµ‚äº†ã—ã€é€šå¸¸ã‚²ãƒ¼ãƒ ã¸ç§»è¡Œã—ã¾ã™ã€‚é ‘å¼µã£ã¦ãƒãƒƒãƒ—ã‚’å¢—ã‚„ã—ã¾ã—ã‚‡ã†ï¼');
                    resetGame(false); // ãƒ¢ãƒ¼ãƒ€ãƒ«ãªã—ã§é€šå¸¸ã‚²ãƒ¼ãƒ ã¸
                };
                break;
        }
    }


    // ----------------------------------------------------
    //  ã‚²ãƒ¼ãƒ ãƒ•ãƒ­ãƒ¼é–¢æ•°
    // ----------------------------------------------------
    
    function resetGame(shouldShowRuleModal = true) {
        deck = [];
        dealerHand = [];
        playerHand = [];
        communityCards = [];
        pot = 0;
        dealerBet = 0;
        playerBet = 0;
        currentBettingRound = 0;
        isGameOver = true;
        lastRaiser = null;
        isTutorial = false;
        tutorialStep = 0;

        chips = 1000; // ãƒãƒƒãƒ—ã‚’ãƒªã‚»ãƒƒãƒˆ

        renderHands(false);
        updateDisplay();

        dealerHandStatusEl.textContent = '?';
        playerHandStatusEl.textContent = '?';
        
        dealButton.style.display = 'block';
        tutorialButton.style.display = 'inline-block'; // ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ãƒœã‚¿ãƒ³å†è¡¨ç¤º
        actionButtons.style.display = 'none';
        postGameButtons.style.display = 'none';
        ruleButton.style.display = 'inline-block';
        
        nextGameButton.textContent = 'æ¬¡ã®å‹è² ã¸'; // ãƒœã‚¿ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã™
        nextGameButton.onclick = () => resetGame(false); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å‹•ä½œã«æˆ»ã™
        
        if (shouldShowRuleModal) {
            ruleModal.style.display = 'flex'; // åˆå›ã¯ãƒ«ãƒ¼ãƒ«è¡¨ç¤º
        } else {
            displayDealerMessage('start');
        }
    }

    function startGame() {
        const ante = parseInt(anteAmountInput.value);
        if (chips < ante) {
            displayDealerMessage('default', 0, '', 'ãƒãƒƒãƒ—ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚ã‚¢ãƒ³ãƒ†ã‚£ã‚’æ¸›ã‚‰ã—ã¦ãã ã•ã„ã€‚');
            return;
        }

        isGameOver = false;
        createAndShuffleDeck();
        
        // ã‚¢ãƒ³ãƒ†ã‚£ã®å‡¦ç†
        chips -= ante;
        pot += ante * 2; 
        playerBet = ante;
        dealerBet = ante; 
        
        playerHand.push(drawCard(), drawCard());
        dealerHand.push(drawCard(), drawCard());

        renderHands(false);
        updateDisplay();

        displayDealerMessage('ante', ante);

        currentBettingRound = 0;
        lastRaiser = 'dealer'; 
        
        // æœ€åˆã®ãƒ™ãƒƒãƒ†ã‚£ãƒ³ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰é–‹å§‹ (ãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼ã‹ã‚‰)
        dealerAction();
    }
    
    // ãƒ™ãƒƒãƒ†ã‚£ãƒ³ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰çµ‚äº†åˆ¤å®š
    function isBettingRoundOver() {
        // åŒæ–¹ã®ãƒ™ãƒƒãƒˆé¡ãŒç­‰ã—ã„ && èª°ã‹ãŒã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’èµ·ã“ã—ãŸ (ãƒ—ãƒªãƒ•ãƒ­ãƒƒãƒ—ä»¥å¤–ã¯èª°ã‹ãŒãƒ™ãƒƒãƒˆ)
        if (dealerBet === playerBet && (dealerBet > 0 || currentBettingRound > 0 || (dealerBet === 0 && playerBet === 0))) {
            return true;
        }
        return false;
    }

    function dealerAction() {
        if (isGameOver) return;
        
        // ãƒ™ãƒƒãƒ†ã‚£ãƒ³ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰çµ‚äº†åˆ¤å®š
        if (isBettingRoundOver()) {
             actionButtons.style.display = 'none';
             setTimeout(nextPhase, 1000); 
             return;
        }
        
        // ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ä¸­ã®ãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¯ã‚¹ã‚­ãƒƒãƒ—ï¼ˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ“ä½œã‚’å¾…ã¤ï¼‰
        if (isTutorial && (tutorialStep === 5 || tutorialStep === 7)) {
            // ãƒ•ãƒ­ãƒƒãƒ—å¾Œã®ãƒã‚§ãƒƒã‚¯èª˜å°æ™‚ (Step 5) ã¨ã€ãƒ¬ã‚¤ã‚ºå¾Œã®ã‚³ãƒ¼ãƒ«èª˜å°æ™‚ (Step 7) ã®ã¿ãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼AIãƒ­ã‚¸ãƒƒã‚¯ã‚’ãƒã‚¤ãƒ‘ã‚¹
            if (tutorialStep === 5) {
                // ãƒã‚§ãƒƒã‚¯ã‚’å¼·åˆ¶
                displayDealerMessage('dealer_check');
                lastRaiser = 'dealer';
                playerActionPhase(); 
            } else if (tutorialStep === 7) {
                // ã‚³ãƒ¼ãƒ«ã‚’å¼·åˆ¶
                const requiredCall = playerBet - dealerBet;
                pot += requiredCall;
                dealerBet += requiredCall;
                displayDealerMessage('dealer_call');
                lastRaiser = 'dealer';
                
                // ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«é€²è¡Œ
                setTimeout(hideMessagePopup, 1000);
            }
            updateDisplay();
            return;
        }


        // ãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼ã®AIãƒ­ã‚¸ãƒƒã‚¯ï¼ˆç°¡ç•¥åŒ–ï¼‰ - é€šå¸¸ã‚²ãƒ¼ãƒ ç”¨
        const cardsToEvaluate = [...dealerHand, ...communityCards];
        const dealerResult = evaluateHand(cardsToEvaluate);
        const requiredCall = playerBet - dealerBet;
        const currentPot = pot + dealerBet + playerBet;
        let action = 'check';
        let raiseAmount = 0;
        
        const winProbability = dealerResult.rank / 10;
        
        if (requiredCall > 0) {
            // ã‚³ãƒ¼ãƒ«ãŒå¿…è¦ãªå ´åˆ (é€šå¸¸AI)
            if (requiredCall > currentPot * 0.3) {
                if (winProbability < 0.3) { action = 'fold'; } else { action = 'call'; }
            } else {
                 if (winProbability < 0.2) { action = 'fold'; } else { action = 'call'; }
            }
        } 
        else {
            // ãƒã‚§ãƒƒã‚¯/ãƒ™ãƒƒãƒˆå¯èƒ½ãªå ´åˆ (é€šå¸¸AI)
            if (winProbability > 0.6 || (dealerResult.rank >= 2 && Math.random() < 0.3)) { 
                action = 'bet';
                raiseAmount = Math.max(playerBet + 10, 20); 
            } else {
                action = 'check';
            }
        }

        // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
        if (action === 'fold') {
            endGame('dealer_fold', currentPot);
        } else if (action === 'call') {
            pot += requiredCall;
            dealerBet += requiredCall;
            displayDealerMessage('dealer_call');
            lastRaiser = 'dealer';
            
            if (isBettingRoundOver()) {
                setTimeout(nextPhase, 1000);
            } else {
                 playerActionPhase();
            }
            
        } else if (action === 'bet') {
            const betAmount = raiseAmount;
            const toBet = betAmount - dealerBet;
            
            pot += toBet; 
            dealerBet = betAmount;
            displayDealerMessage('dealer_bet', betAmount);
            lastRaiser = 'dealer';
            playerActionPhase();
            
        } else if (action === 'check') {
            displayDealerMessage('dealer_check');
            lastRaiser = 'dealer';
            
            if (isBettingRoundOver()) {
                setTimeout(nextPhase, 1000);
            } else {
                playerActionPhase();
            }
        }
        
        updateDisplay();
    }

    function playerActionPhase() {
        hideMessagePopup(); 
        dealButton.style.display = 'none';
        postGameButtons.style.display = 'none';
        actionButtons.style.display = 'flex';
        
        const requiredCall = dealerBet - playerBet;
        
        foldButton.disabled = false;
        
        // UIã®æ˜ç¢ºåŒ–ãƒ­ã‚¸ãƒƒã‚¯å¼·åŒ–
        if (requiredCall > 0) {
            // ã‚³ãƒ¼ãƒ«ãŒå¿…è¦ãªå ´åˆ
            checkCallButton.textContent = `ã‚³ãƒ¼ãƒ« (${requiredCall})`;
            checkCallButton.disabled = chips < requiredCall;
            raiseButton.disabled = chips < requiredCall + 10;
        } else {
            // ãƒã‚§ãƒƒã‚¯ãŒå¯èƒ½ãªå ´åˆ
            checkCallButton.textContent = 'ãƒã‚§ãƒƒã‚¯';
            checkCallButton.disabled = false;
            raiseButton.disabled = chips < 10; // æœ€å°ãƒ™ãƒƒãƒˆé¡10ã§ãƒ¬ã‚¤ã‚ºå¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
        }
        
        raiseAmountInput.min = Math.max(requiredCall + 10, 10);
        if (parseInt(raiseAmountInput.value) < raiseAmountInput.min) {
            raiseAmountInput.value = raiseAmountInput.min;
        }
    }

    function handlePlayerAction(type) {
        if (isGameOver) return;
        
        const requiredCall = dealerBet - playerBet;
        const raiseAmount = parseInt(raiseAmountInput.value);
        
        if (type === 'fold') {
            endGame('player_fold', pot + dealerBet + playerBet);
            return;
        } 
        
        if (type === 'call_check') {
            if (requiredCall > 0) { // ã‚³ãƒ¼ãƒ«
                if (chips < requiredCall) return;
                chips -= requiredCall;
                pot += requiredCall;
                playerBet += requiredCall;
                
                displayDealerMessage('default', 0, '', `ã‚ãªãŸã¯ã‚³ãƒ¼ãƒ« (${requiredCall}) ã—ã¾ã—ãŸã€‚`);
                lastRaiser = 'player';
                
                if (isTutorial) {
                    setTimeout(hideMessagePopup, 1000); 
                    return;
                }
                
                if (isBettingRoundOver()) {
                    setTimeout(nextPhase, 1000);
                } else {
                    dealerAction();
                }
                return;

            } else { // ãƒã‚§ãƒƒã‚¯
                // ãƒã‚§ãƒƒã‚¯å¾Œã®å‡¦ç†
                displayDealerMessage('default', 0, '', 'ã‚ãªãŸã¯ãƒã‚§ãƒƒã‚¯ã—ã¾ã—ãŸã€‚');
                lastRaiser = 'player';
                
                if (isTutorial) {
                    setTimeout(hideMessagePopup, 1000); 
                    return;
                }

                if (isBettingRoundOver()) {
                    setTimeout(nextPhase, 1000);
                } else {
                    dealerAction();
                }
                return;
            }
        }
        
        if (type === 'raise') {
            if (raiseAmount < requiredCall + 10 || chips < raiseAmount) return;

            const totalBet = raiseAmount; 
            const toBet = totalBet - playerBet; 
            
            chips -= toBet;
            pot += toBet;
            playerBet = totalBet; 
            
            displayDealerMessage('default', 0, '', `ã‚ãªãŸã¯ ${totalBet} ã«ãƒ¬ã‚¤ã‚ºã—ã¾ã—ãŸã€‚`);
            lastRaiser = 'player';

            if (isTutorial) {
                setTimeout(hideMessagePopup, 1000); 
                return;
            }

            dealerAction();
            return;
        }

        updateDisplay();
    }
    
    function nextPhase() {
        if (isGameOver) return;
        
        hideMessagePopup();
        
        // ãƒãƒƒãƒˆã«ãƒ™ãƒƒãƒˆé¡ã‚’ç§»å‹•ã—ã€ãƒªã‚»ãƒƒãƒˆ
        pot += dealerBet + playerBet; 
        dealerBet = 0;
        playerBet = 0;
        lastRaiser = null;

        currentBettingRound++;
        
        if (currentBettingRound === 1) {
            // ãƒ•ãƒ­ãƒƒãƒ— (3æš)
            if (!isTutorial) {
                communityCards.push(drawCard(), drawCard(), drawCard());
                displayDealerMessage('flop');
            } 
            renderHands(false); 
            updateDisplay();

            if (isTutorial) {
                handleTutorialStep(); 
                return;
            }
        } else if (currentBettingRound === 2) {
            // ã‚¿ãƒ¼ãƒ³ (4æšç›®)
            if (!isTutorial) communityCards.push(drawCard());
            
            renderHands(false); 
            updateDisplay();

            if (isTutorial) {
                handleTutorialStep(); 
                return;
            } else {
                displayDealerMessage('turn');
            }
        } else if (currentBettingRound === 3) {
            // ãƒªãƒãƒ¼ (5æšç›®)
            if (!isTutorial) communityCards.push(drawCard());
            
            renderHands(false); 
            updateDisplay();

            if (isTutorial) {
                handleTutorialStep(); 
                return;
            } else {
                displayDealerMessage('river');
            }
        } else if (currentBettingRound >= 4) {
            showdown();
            return;
        }

        // æ¬¡ã®ãƒ™ãƒƒãƒ†ã‚£ãƒ³ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰é–‹å§‹ (ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‹ã‚‰ã‚¢ã‚¯ã‚·ãƒ§ãƒ³)
        playerActionPhase(); 
    }

    function showdown() {
        isGameOver = true;
        renderHands(true); 

        const playerResult = evaluateHand([...playerHand, ...communityCards]);
        const dealerResult = evaluateHand([...dealerHand, ...communityCards]);
        
        let winner = 'none';
        
        if (playerResult.rank > dealerResult.rank) {
            winner = 'player';
        } else if (playerResult.rank < dealerResult.rank) {
            winner = 'dealer';
        } else {
            winner = 'push'; 
        }
        
        let finalPot = pot + dealerBet + playerBet;

        if (winner === 'player') {
            chips += finalPot;
            displayDealerMessage('player_win_showdown', finalPot, playerResult.name);
        } else if (winner === 'dealer') {
            displayDealerMessage('dealer_win_showdown', 0, dealerResult.name);
        } else {
            chips += Math.floor(finalPot / 2);
            displayDealerMessage('push', finalPot);
        }

        pot = 0; dealerBet = 0; playerBet = 0;

        updateDisplay();
        dealButton.style.display = 'none';
        actionButtons.style.display = 'none';
        
        if (!isTutorial) {
             postGameButtons.style.display = 'block';
        } else {
             handleTutorialStep(); // ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã®æœ€çµ‚ã‚¹ãƒ†ãƒƒãƒ—ã¸
        }
    }

    function endGame(reason, finalPot) {
        isGameOver = true;
        
        if (reason === 'player_fold') {
            displayDealerMessage('player_fold', finalPot);
        } else if (reason === 'dealer_fold') {
            chips += finalPot;
            displayDealerMessage('dealer_fold', finalPot);
        }
        
        pot = 0; dealerBet = 0; playerBet = 0;

        updateDisplay();
        dealButton.style.display = 'none';
        actionButtons.style.display = 'none';
        postGameButtons.style.display = 'block';
    }


    // ----------------------------------------------------
    //  ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ / åˆæœŸåŒ–
    // ----------------------------------------------------
    dealButton.addEventListener('click', startGame);
    document.getElementById('nextGameButton').addEventListener('click', () => resetGame(false));
    
    // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³
    foldButton.addEventListener('click', () => handlePlayerAction('fold'));
    checkCallButton.addEventListener('click', () => handlePlayerAction('call_check'));
    raiseButton.addEventListener('click', () => handlePlayerAction('raise'));

    // ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ãƒœã‚¿ãƒ³
    tutorialButton.addEventListener('click', startTutorial);
    
    // ãƒ«ãƒ¼ãƒ«ãƒ¢ãƒ¼ãƒ€ãƒ«ã®åˆ¶å¾¡
    ruleButton.addEventListener('click', () => {
        ruleModal.style.display = 'flex';
    });

    function hideModal() {
        ruleModal.style.display = 'none';
    }
    closeModalButton.addEventListener('click', hideModal);

    // åˆå›è¡¨ç¤º
    updateDisplay();
    ruleModal.style.display = 'flex'; // åˆå›ã¯ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    
</script>
</body>
</html>
